# 行程编辑功能说明

## 概述
新增了完整的行程编辑功能，用户可以对每天的活动进行增删改操作，并通过地图搜索添加地点，系统会自动进行路线规划。

## 主要功能

### 1. 行程编辑模式

#### 1.1 编辑/查看模式切换
- **查看模式**：默认状态，显示只读的行程信息
  - 点击"✏️ 编辑行程"按钮进入编辑模式
  - 可以删除整个行程

- **编辑模式**：允许修改行程内容
  - 点击"💾 保存更改"按钮保存修改
  - 点击"❌ 取消编辑"退出编辑模式（有未保存更改时会提示确认）
  - 显示未保存更改提示

#### 1.2 活动管理功能

**添加活动**：
- 点击"+ 添加活动"按钮手动添加活动
- 点击"📍 从地图选择"按钮通过搜索地图添加活动
- 填写活动信息：
  - 活动类型（景点/餐厅/酒店/交通/娱乐/购物）
  - 活动名称（必填）
  - 描述
  - 开始时间
  - 预计时长（分钟）
  - 预计费用（元）

**编辑活动**：
- 点击活动右侧的"✏️"按钮进入编辑状态
- 可以修改活动的所有信息
- 点击"保存"确认更改，点击"取消"放弃更改

**删除活动**：
- 点击活动右侧的"🗑️"按钮删除活动
- 需要确认操作

**调整顺序**：
- 点击活动右侧的"⬆️"按钮上移活动
- 点击活动右侧的"⬇️"按钮下移活动
- 系统会自动更新活动顺序

### 2. 地图搜索功能

#### 2.1 搜索地点
- 在编辑模式下，点击"📍 从地图选择"按钮
- 打开地图搜索界面
- 在搜索框中输入地点名称
- 系统会在当前目的地城市内搜索相关地点

#### 2.2 选择地点
- 浏览搜索结果列表
- 点击任意地点自动添加到当前天的行程中
- 添加后地图会自动聚焦到新地点
- 自动填充地点信息：
  - 名称
  - 地址
  - 经纬度坐标

#### 2.3 搜索结果展示
- 显示地点名称
- 显示详细地址
- 显示联系电话（如有）
- 显示距离信息（如有）

### 3. 路线规划功能

#### 3.1 自动路线规划
- 在编辑模式下，当某天有2个或以上的活动时
- 系统会自动调用高德地图路线规划API
- 按照活动顺序规划步行路线
- 显示"正在规划路线..."提示

#### 3.2 路线显示
- 在地图上绘制详细的步行路线
- 显示路线方向箭头
- 在路线中点显示距离和时间标签
- 不同于查看模式的简单连线

#### 3.3 路线信息统计
- 总距离（公里）
- 预计时间（分钟）
- 出行方式（步行）
- 实时更新（活动变化时自动重新规划）

### 4. 地图交互功能

#### 4.1 地点聚焦
- 点击行程中的活动，地图自动聚焦到该地点
- 平滑动画移动
- 自动调整缩放级别（16级）

#### 4.2 标记显示
- 在地图上显示当前天所有活动的位置标记
- 标记上显示地点名称
- 点击标记可查看详情

#### 4.3 视野调整
- 切换天数时自动调整地图视野
- 单个标记时居中显示
- 多个标记时自动适配所有标记

## 技术实现

### 后端API

#### 1. 更新行程 
```
PUT /api/itinerary/:id
```
- 支持更新行程的所有信息
- 验证用户权限
- 返回更新后的行程数据

#### 2. 地图搜索
```
POST /api/location/search
```
- 参数：keywords, city
- 返回：POI列表

#### 3. 路线规划
```
POST /api/location/route
```
- 参数：origin, destination, mode
- 返回：路线详情（距离、时间、路径坐标）

#### 4. 批量路线规划
```
POST /api/location/routes/batch
```
- 参数：locations[], mode
- 返回：多段路线数组

### 前端组件

#### 1. EditableItineraryDay.tsx
- 可编辑的单日行程组件
- 支持增删改活动
- 支持拖拽排序
- 内联编辑器

#### 2. MapSearch.tsx
- 地图搜索组件
- 搜索框 + 结果列表
- 支持键盘回车搜索
- 美观的UI展示

#### 3. MapContainer.tsx（增强）
- 支持路线规划显示
- 支持详细路径绘制
- 支持路线信息标签
- 区分简单路径和详细路线

### 前端服务

#### 1. location.ts
- searchLocation：搜索地点
- getRoute：获取单段路线
- batchRoutes：批量路线规划

#### 2. itinerary.ts（增强）
- updateItinerary：更新行程

## 使用流程

### 典型编辑流程：

1. **进入编辑模式**
   - 打开行程详情页
   - 点击"✏️ 编辑行程"按钮

2. **修改活动**
   - 选择要编辑的天数
   - 添加/编辑/删除活动
   - 调整活动顺序

3. **从地图添加地点**
   - 点击"📍 从地图选择"
   - 搜索地点
   - 点击选择
   - 地点自动添加到行程中

4. **查看路线规划**
   - 系统自动规划路线
   - 查看地图上的详细路径
   - 查看路线统计信息

5. **保存更改**
   - 点击"💾 保存更改"按钮
   - 等待保存完成
   - 自动退出编辑模式

## 注意事项

1. **权限控制**
   - 只有行程所有者才能编辑
   - 需要登录才能保存更改

2. **数据验证**
   - 活动名称为必填项
   - 坐标数据会自动验证有效性

3. **自动保存**
   - 系统不会自动保存
   - 必须手动点击保存按钮
   - 退出编辑模式时会提示未保存更改

4. **路线规划限制**
   - 需要配置高德地图API Key
   - 仅在编辑模式下自动规划
   - 支持步行和驾车两种模式（当前使用步行）

5. **地图搜索限制**
   - 需要配置高德地图API Key
   - 搜索范围限定在目的地城市
   - 每次返回最多10个结果

## 后续优化建议

1. **拖拽排序**
   - 支持鼠标拖拽调整活动顺序

2. **批量操作**
   - 支持批量删除活动
   - 支持复制活动到其他天

3. **更多路线模式**
   - 支持公交路线规划
   - 支持自定义出行方式

4. **离线编辑**
   - 支持本地暂存未保存的更改
   - 网络恢复后自动同步

5. **协作编辑**
   - 支持多人同时编辑
   - 实时同步更改

6. **智能推荐**
   - 基于已选地点推荐周边景点
   - 智能调整活动时间安排

