# 使用说明和调试指南

## 当前修复的问题

我已经修复了以下问题：

### 1. 行程生成显示问题
- ✅ 添加了详细的控制台日志
- ✅ 改进了SSE流式响应处理
- ✅ 修复了生成完成后状态不更新的问题
- ✅ 添加了缓冲区处理，避免JSON解析错误

### 2. 认证状态问题
- ✅ 添加了详细的认证日志
- ✅ 改进了认证状态初始化

## 如何测试

### 步骤1：启动后端
```bash
cd backend
npm install
npm run dev
```

后端应该在 `http://localhost:3000` 运行

### 步骤2：启动前端
```bash
cd frontend
npm install
npm run dev
```

前端应该在 `http://localhost:5173` 运行

### 步骤3：测试流程

#### 3.1 注册新用户
1. 访问 `http://localhost:5173`
2. 点击"注册"
3. 输入邮箱和密码（密码至少6位）
4. 提交注册

**打开浏览器控制台（F12）查看日志**：
- 应该看到 "Login successful:" 或 "Register successful"
- 应该看到用户信息

#### 3.2 生成行程
1. 点击"开始规划旅行"
2. 填写以下信息：
   - 目的地：**北京**（建议用国内城市，地点验证更准确）
   - 天数：**3**（建议先测试少天数）
   - 人数：1
   - 预算：可选
3. 点击"开始生成行程"

**查看控制台日志**：
- 应该看到 "Generating itinerary with requirements:"
- 应该看到 "Response status: 200"
- 应该看到多个 "Received data:" 日志
- 最后应该看到 "Itinerary generated:" 和完整的行程数据

**查看后端日志**（后端终端）：
- 应该看到 "Generate request:"
- 应该看到 "Travel requirements:"
- 应该看到 "Step 1: Generating initial itinerary..."
- 应该看到各个步骤的日志

### 步骤4：检查登录状态

打开浏览器控制台，输入：
```javascript
localStorage
```

应该能看到Supabase的认证信息。

## 常见问题排查

### 问题1：生成行程时一直显示加载
**可能原因**：
1. DeepSeek API Key无效或超额
2. 网络连接问题
3. 后端没有正确启动

**解决方法**：
1. 检查后端日志，查看具体错误信息
2. 检查 `backend/.env` 中的 `DEEPSEEK_API_KEY` 是否正确
3. 尝试用更简单的目的地（如"北京"）

### 问题2：生成后不显示结果
**可能原因**：
1. SSE响应被中断
2. 数据格式不匹配

**解决方法**：
1. 打开浏览器控制台，查看是否有 "Itinerary generated:" 日志
2. 如果有日志，检查数据结构是否正确
3. 查看后端日志，确认 "Final itinerary:" 输出

### 问题3：点击"我的行程"跳转到登录页
**可能原因**：
1. 用户没有登录
2. 登录状态没有正确保存

**解决方法**：
1. 打开控制台，查看 "Home - Auth state:" 日志
2. 如果 `isAuthenticated: false`，说明用户未登录或会话已过期
3. 重新登录后再试

### 问题4：Supabase错误
**可能原因**：
1. 数据库表未创建
2. RLS策略问题

**解决方法**：
1. 登录Supabase控制台
2. 在SQL Editor中执行 `backend/supabase-schema.sql`
3. 确认所有表都已创建

## 调试技巧

### 1. 查看完整的网络请求
在浏览器控制台的 Network 标签：
1. 刷新页面
2. 点击生成行程
3. 找到 `/api/itinerary/generate` 请求
4. 查看 Response 标签，应该能看到SSE数据流

### 2. 测试API是否正常
在浏览器控制台或Postman测试：
```javascript
fetch('http://localhost:3000/health')
  .then(r => r.json())
  .then(console.log)
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2025-11-02..."
}
```

### 3. 查看Supabase认证状态
在浏览器控制台：
```javascript
// 查看localStorage中的认证信息
Object.keys(localStorage).filter(k => k.includes('supabase'))
```

### 4. 测试简化版行程生成
如果完整行程生成有问题，可以先测试简化版：
- 目的地：北京
- 天数：2
- 不填预算和其他信息

## 预期的控制台输出

### 成功的行程生成流程应该看到：

```
Generating itinerary with requirements: {destination: "北京", days: 3, travelers: 1}
Response status: 200
Received data: {"step":"generating","progress":10}
Progress update: {step: "generating", progress: 10}
Received data: {"step":"validating","progress":40}
Progress update: {step: "validating", progress: 40}
Received data: {"step":"enriching","progress":70}
Progress update: {step: "enriching", progress: 70}
Received data: {"step":"finalizing","progress":90}
Progress update: {step: "finalizing", progress: 90}
Received data: {"step":"complete","progress":100,"data":{...}}
Progress update: {step: "complete", progress: 100, data: {...}}
Itinerary generated: {title: "北京3日游", destination: "北京", days: [...]}
Stream completed
```

## 如果还是不行

请提供以下信息：
1. 浏览器控制台的完整日志（截图或文本）
2. 后端终端的日志（截图或文本）
3. 具体的错误信息
4. 测试时使用的目的地和天数

这样我可以更准确地定位问题。

## 快速验证清单

- [ ] 后端已启动（http://localhost:3000/health 返回 ok）
- [ ] 前端已启动（http://localhost:5173 可以访问）
- [ ] Supabase数据库表已创建
- [ ] 环境变量已正确配置（.env文件）
- [ ] 已注册并登录用户
- [ ] 浏览器控制台没有红色错误
- [ ] 后端终端没有错误日志

