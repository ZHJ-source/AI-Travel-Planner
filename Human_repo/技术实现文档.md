# AI 旅行规划师技术实现文档

## 目录
1. [技术架构概览](#技术架构概览)
2. [技术栈选型](#技术栈选型)
3. [系统架构设计](#系统架构设计)
4. [核心模块实现](#核心模块实现)
5. [数据库设计](#数据库设计)
6. [API集成方案](#api集成方案)
7. [部署方案](#部署方案)
8. [开发规范](#开发规范)

---

## 技术架构概览

### 整体架构
采用前后端分离的架构设计：
- **前端**：React + TypeScript 单页应用
- **后端**：Node.js + Express RESTful API
- **数据库**：Supabase (PostgreSQL)
- **部署**：Docker容器化部署

### 架构图
```
┌─────────────────────────────────────────────────────────┐
│                        用户端                            │
│                   (浏览器/Web应用)                       │
└─────────────────────┬───────────────────────────────────┘
                      │
                      │ HTTPS
                      │
┌─────────────────────▼───────────────────────────────────┐
│                   前端应用层                             │
│   React + TypeScript + TailwindCSS + Zustand           │
│                                                          │
│   - 地图交互界面 (高德地图JS API)                        │
│   - 语音输入组件 (科大讯飞WebSocket)                     │
│   - 行程展示与管理                                        │
│   - 用户认证界面                                          │
└─────────────────────┬───────────────────────────────────┘
                      │
                      │ REST API
                      │
┌─────────────────────▼───────────────────────────────────┐
│                   后端API层                              │
│              Node.js + Express                          │
│                                                          │
│   - 行程规划服务                                          │
│   - 地点验证服务                                          │
│   - 费用计算服务                                          │
│   - 用户管理服务                                          │
└─────────┬───────────┬──────────┬────────────────────────┘
          │           │          │
          │           │          │
    ┌─────▼────┐ ┌───▼────┐ ┌──▼──────┐
    │ Supabase │ │ DeepSeek│ │高德地图 │
    │ Database │ │   LLM   │ │  API    │
    └──────────┘ └─────────┘ └─────────┘
```

---

## 技术栈选型

### 前端技术栈

#### 核心框架
- **React 18**
  - 理由：组件化开发，生态成熟，性能优异
  - 使用函数组件 + Hooks
  
- **TypeScript 5**
  - 理由：类型安全，提高代码质量和可维护性
  - 严格模式配置

#### UI框架与工具
- **TailwindCSS 3**
  - 理由：快速构建现代化UI，高度可定制
  - 响应式设计支持
  
- **Ant Design / shadcn/ui**
  - 理由：提供高质量组件，加速开发
  - 可选择其一或结合使用
  
- **Framer Motion**
  - 理由：流畅的动画效果
  - 地图平滑移动、页面过渡动画

#### 状态管理
- **Zustand**
  - 理由：轻量级，API简洁，TypeScript支持好
  - 管理全局状态（用户信息、行程数据、地图状态）

#### 路由
- **React Router v6**
  - 理由：标准路由解决方案
  - 支持嵌套路由和懒加载

#### 构建工具
- **Vite**
  - 理由：极快的开发服务器启动速度
  - 优秀的开发体验和构建性能

### 后端技术栈

#### 运行环境
- **Node.js 20 LTS**
  - 理由：稳定、性能好、生态成熟

#### Web框架
- **Express.js**
  - 理由：轻量、灵活、中间件生态丰富
  - 易于集成各类服务

#### 认证
- **Supabase Auth**
  - 理由：开箱即用的用户认证系统
  - 支持邮箱登录、JWT token管理

### 数据库
- **Supabase (PostgreSQL)**
  - 理由：
    - 托管式PostgreSQL，免运维
    - 内置实时订阅功能
    - Row Level Security (RLS) 保证数据安全
    - 自动生成RESTful API

### 外部API集成

#### 语音识别
- **科大讯飞语音听写 (WebSocket API)**
  - 实时语音转文字
  - 支持中英文识别
  - 提供WebSocket接口，适合Web应用

#### 地图服务
- **高德地图**
  - **Web服务API**：后端调用，进行地点搜索、路径规划
  - **JS API 2.0**：前端调用，地图展示和交互
  - POI搜索、逆地理编码、路径规划等功能

#### 大语言模型
- **DeepSeek API**
  - 行程规划生成
  - 费用预算分析
  - 附属事件筛选
  - 使用流式响应提升用户体验

---

## 系统架构设计

### 前端架构

#### 目录结构
```
frontend/
├── src/
│   ├── assets/           # 静态资源
│   ├── components/       # 通用组件
│   │   ├── common/       # 基础组件
│   │   ├── map/          # 地图相关组件
│   │   ├── itinerary/    # 行程相关组件
│   │   └── voice/        # 语音输入组件
│   ├── pages/            # 页面组件
│   │   ├── Home/         # 首页
│   │   ├── Planning/     # 规划页面
│   │   ├── Itinerary/    # 行程详情
│   │   ├── Profile/      # 用户中心
│   │   └── Auth/         # 登录注册
│   ├── hooks/            # 自定义Hooks
│   │   ├── useVoice.ts   # 语音输入Hook
│   │   ├── useMap.ts     # 地图操作Hook
│   │   └── useAuth.ts    # 认证Hook
│   ├── stores/           # Zustand状态管理
│   │   ├── authStore.ts  # 用户状态
│   │   ├── itineraryStore.ts  # 行程状态
│   │   └── mapStore.ts   # 地图状态
│   ├── services/         # API服务
│   │   ├── api.ts        # API配置
│   │   ├── auth.ts       # 认证相关
│   │   ├── itinerary.ts  # 行程相关
│   │   └── map.ts        # 地图相关
│   ├── types/            # TypeScript类型定义
│   ├── utils/            # 工具函数
│   ├── App.tsx
│   └── main.tsx
├── public/
├── .env.example
├── package.json
├── tsconfig.json
└── vite.config.ts
```

#### 核心组件设计

**地图组件 (MapContainer)**
```typescript
interface MapContainerProps {
  markers: Marker[];
  onMarkerClick: (marker: Marker) => void;
  onMapClick: (location: Location) => void;
  center?: Location;
  zoom?: number;
}
```
- 集成高德地图JS API
- 支持标记添加/删除
- 路线绘制
- 平滑动画移动

**语音输入组件 (VoiceInput)**
```typescript
interface VoiceInputProps {
  onTranscript: (text: string) => void;
  onError: (error: Error) => void;
}
```
- WebSocket连接科大讯飞
- 实时语音识别
- 音量可视化
- 错误处理

**行程展示组件 (ItineraryView)**
```typescript
interface ItineraryViewProps {
  itinerary: Itinerary;
  viewMode: 'timeline' | 'list' | 'map';
  onEventClick: (event: Event) => void;
  onEventEdit: (event: Event) => void;
  onEventDelete: (eventId: string) => void;
}
```
- 时间线视图
- 列表视图
- 地图视图切换
- 拖拽排序

### 后端架构

#### 目录结构
```
backend/
├── src/
│   ├── config/           # 配置文件
│   │   ├── database.ts   # 数据库配置
│   │   ├── apis.ts       # 外部API配置
│   │   └── env.ts        # 环境变量
│   ├── middleware/       # 中间件
│   │   ├── auth.ts       # 认证中间件
│   │   ├── error.ts      # 错误处理
│   │   └── validate.ts   # 请求验证
│   ├── routes/           # 路由
│   │   ├── auth.ts       # 认证路由
│   │   ├── itinerary.ts  # 行程路由
│   │   ├── budget.ts     # 预算路由
│   │   └── user.ts       # 用户路由
│   ├── services/         # 业务逻辑
│   │   ├── llm/          # LLM服务
│   │   │   ├── planner.ts    # 行程规划
│   │   │   └── budget.ts     # 预算分析
│   │   ├── map/          # 地图服务
│   │   │   ├── geocoding.ts  # 地理编码
│   │   │   ├── poi.ts        # POI搜索
│   │   │   └── route.ts      # 路径规划
│   │   └── itinerary/    # 行程服务
│   │       ├── generator.ts  # 行程生成
│   │       ├── validator.ts  # 地点验证
│   │       └── optimizer.ts  # 行程优化
│   ├── models/           # 数据模型
│   │   ├── User.ts
│   │   ├── Itinerary.ts
│   │   └── Event.ts
│   ├── types/            # TypeScript类型
│   ├── utils/            # 工具函数
│   └── app.ts            # 应用入口
├── tests/                # 测试
├── .env.example
├── package.json
└── tsconfig.json
```

#### API设计

**认证相关**
```
POST   /api/auth/register      # 用户注册
POST   /api/auth/login         # 用户登录
POST   /api/auth/logout        # 用户登出
POST   /api/auth/refresh       # 刷新Token
POST   /api/auth/reset-password # 重置密码
```

**行程规划**
```
POST   /api/itinerary/generate     # 生成行程（流式响应）
GET    /api/itinerary/list         # 获取行程列表
GET    /api/itinerary/:id          # 获取行程详情
PUT    /api/itinerary/:id          # 更新行程
DELETE /api/itinerary/:id          # 删除行程
POST   /api/itinerary/:id/event    # 添加事件
PUT    /api/itinerary/:id/event/:eventId  # 更新事件
DELETE /api/itinerary/:id/event/:eventId  # 删除事件
```

**地点服务**
```
POST   /api/location/validate      # 验证地点是否存在
POST   /api/location/search        # 搜索地点
GET    /api/location/poi           # 获取周边POI
POST   /api/location/route         # 规划路线
```

**预算服务**
```
POST   /api/budget/estimate        # 估算预算
GET    /api/budget/:itineraryId    # 获取行程预算
```

**用户服务**
```
GET    /api/user/profile           # 获取用户信息
PUT    /api/user/profile           # 更新用户信息
GET    /api/user/preferences       # 获取用户偏好
PUT    /api/user/preferences       # 更新用户偏好
```

---

## 核心模块实现

### 1. 智能行程规划模块

#### 实现流程

**第一步：用户输入处理**
```typescript
// 前端：语音输入处理
const handleVoiceInput = async (audioBlob: Blob) => {
  // 1. 建立WebSocket连接到科大讯飞
  const ws = new WebSocket(XUNFEI_WS_URL);
  
  // 2. 发送音频数据
  ws.send(audioBlob);
  
  // 3. 接收识别结果
  ws.onmessage = (event) => {
    const result = JSON.parse(event.data);
    setTranscript(result.text);
  };
};

// 后端：解析用户需求
const parseUserRequirements = async (input: string) => {
  const prompt = `
    解析以下旅行需求，提取关键信息：
    用户输入：${input}
    
    请以JSON格式返回：
    {
      "destination": "目的地",
      "days": 天数,
      "budget": 预算金额,
      "travelers": 人数,
      "preferences": ["偏好1", "偏好2"],
      "specialNeeds": ["特殊需求"]
    }
  `;
  
  const response = await callDeepSeek(prompt);
  return JSON.parse(response);
};
```

**第二步：LLM生成初步行程**
```typescript
const generateItinerary = async (requirements: Requirements) => {
  const prompt = `
    根据以下信息生成${requirements.days}天的旅行计划：
    - 目的地：${requirements.destination}
    - 预算：${requirements.budget}元
    - 人数：${requirements.travelers}人
    - 偏好：${requirements.preferences.join(', ')}
    
    要求：
    1. 每天安排2-4个主要事件（景点、餐厅、娱乐）
    2. 包含具体的地点名称（必须是真实存在的地点）
    3. 安排合理的时间
    4. 考虑交通和住宿
    
    以JSON格式返回，结构如下：
    {
      "days": [
        {
          "date": "2025-11-01",
          "events": [
            {
              "time": "09:00",
              "type": "attraction",
              "name": "东京塔",
              "description": "...",
              "estimatedDuration": 120,
              "estimatedCost": 1000
            }
          ]
        }
      ],
      "transportation": {...},
      "accommodation": {...}
    }
  `;
  
  // 使用流式响应
  const stream = await callDeepSeekStream(prompt);
  return stream;
};
```

**第三步：地点验证**
```typescript
const validateLocations = async (itinerary: Itinerary) => {
  const allEvents = itinerary.days.flatMap(day => day.events);
  
  // 并发验证所有地点
  const validationResults = await Promise.all(
    allEvents.map(async (event) => {
      try {
        // 调用高德地图API验证
        const response = await axios.get('https://restapi.amap.com/v3/place/text', {
          params: {
            key: AMAP_WEB_KEY,
            keywords: event.name,
            city: itinerary.destination,
          }
        });
        
        if (response.data.pois && response.data.pois.length > 0) {
          // 地点存在，更新坐标信息
          return {
            ...event,
            location: {
              lat: response.data.pois[0].location.split(',')[1],
              lng: response.data.pois[0].location.split(',')[0],
            },
            address: response.data.pois[0].address,
            valid: true
          };
        } else {
          // 地点不存在
          return { ...event, valid: false };
        }
      } catch (error) {
        return { ...event, valid: false };
      }
    })
  );
  
  // 移除无效地点
  return filterValidEvents(itinerary, validationResults);
};
```

**第四步：获取周边POI**
```typescript
const getNearbyPOIs = async (location: Location, type: string) => {
  const response = await axios.get('https://restapi.amap.com/v3/place/around', {
    params: {
      key: AMAP_WEB_KEY,
      location: `${location.lng},${location.lat}`,
      types: type, // 餐饮：050000，景点：110000
      radius: 1000, // 1公里范围内
      sortrule: 'distance',
      offset: 10,
    }
  });
  
  return response.data.pois.map(poi => ({
    name: poi.name,
    type: poi.type,
    location: {
      lat: poi.location.split(',')[1],
      lng: poi.location.split(',')[0],
    },
    address: poi.address,
    distance: poi.distance,
  }));
};
```

**第五步：筛选附属事件**
```typescript
const selectSubEvents = async (mainEvent: Event, nearbyPOIs: POI[]) => {
  const prompt = `
    主要事件：${mainEvent.name}（${mainEvent.type}）
    时间：${mainEvent.time}
    
    周边地点：
    ${nearbyPOIs.map(poi => `- ${poi.name}（${poi.type}，距离${poi.distance}米）`).join('\n')}
    
    请从周边地点中选择1-3个适合顺带游览的地点，考虑：
    1. 距离（优先选择500米以内）
    2. 类型互补（如主要事件是景点，可以选择附近餐厅）
    3. 时间充裕度
    
    以JSON数组格式返回选中的地点名称：
    ["地点1", "地点2"]
  `;
  
  const response = await callDeepSeek(prompt);
  const selectedNames = JSON.parse(response);
  
  return nearbyPOIs.filter(poi => selectedNames.includes(poi.name));
};
```

### 2. 地图交互模块

#### 高德地图JS API集成

```typescript
// MapContainer.tsx
import AMapLoader from '@amap/amap-jsapi-loader';

const MapContainer: React.FC<MapContainerProps> = ({ markers, onMarkerClick }) => {
  const mapRef = useRef<any>(null);
  const [map, setMap] = useState<any>(null);
  
  useEffect(() => {
    // 初始化地图
    AMapLoader.load({
      key: AMAP_JS_KEY,
      version: '2.0',
      plugins: ['AMap.Marker', 'AMap.Polyline', 'AMap.PlaceSearch'],
    }).then((AMap) => {
      const mapInstance = new AMap.Map(mapRef.current, {
        zoom: 11,
        center: [116.397428, 39.90923],
      });
      
      setMap(mapInstance);
    });
  }, []);
  
  // 添加标记
  useEffect(() => {
    if (!map) return;
    
    // 清除旧标记
    map.clearMap();
    
    // 添加新标记
    markers.forEach((marker, index) => {
      const aMapMarker = new AMap.Marker({
        position: [marker.lng, marker.lat],
        title: marker.title,
        label: {
          content: `<div class="marker-label">${index + 1}</div>`,
        },
      });
      
      aMapMarker.on('click', () => onMarkerClick(marker));
      map.add(aMapMarker);
    });
    
    // 绘制路线
    if (markers.length > 1) {
      const path = markers.map(m => [m.lng, m.lat]);
      const polyline = new AMap.Polyline({
        path,
        strokeColor: '#3b82f6',
        strokeWeight: 4,
      });
      map.add(polyline);
    }
  }, [map, markers]);
  
  // 平滑移动到指定位置
  const moveToLocation = (location: Location) => {
    map.setZoomAndCenter(15, [location.lng, location.lat], false, 500);
  };
  
  return <div ref={mapRef} className="w-full h-full" />;
};
```

### 3. 语音输入模块

#### 科大讯飞WebSocket集成

```typescript
// useVoice.ts
export const useVoice = () => {
  const [isRecording, setIsRecording] = useState(false);
  const [transcript, setTranscript] = useState('');
  const wsRef = useRef<WebSocket | null>(null);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  
  const startRecording = async () => {
    try {
      // 1. 获取麦克风权限
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      // 2. 创建MediaRecorder
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      
      // 3. 建立WebSocket连接
      const ws = new WebSocket(getXunfeiWebSocketURL());
      wsRef.current = ws;
      
      ws.onopen = () => {
        console.log('WebSocket connected');
        mediaRecorder.start(100); // 每100ms发送一次数据
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.code === 0) {
          // 识别成功
          const result = data.data.result;
          if (result) {
            const text = result.ws.map(w => w.cw[0].w).join('');
            setTranscript(prev => prev + text);
          }
        } else {
          console.error('Recognition error:', data.message);
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      // 4. 音频数据处理
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
          // 将音频数据转换为base64
          const reader = new FileReader();
          reader.onload = () => {
            const base64Audio = reader.result?.toString().split(',')[1];
            
            // 发送音频数据
            ws.send(JSON.stringify({
              data: {
                status: 1, // 0: 第一帧，1: 中间帧，2: 最后一帧
                format: 'audio/L16;rate=16000',
                audio: base64Audio,
                encoding: 'raw',
              }
            }));
          };
          reader.readAsDataURL(event.data);
        }
      };
      
      setIsRecording(true);
    } catch (error) {
      console.error('Failed to start recording:', error);
    }
  };
  
  const stopRecording = () => {
    // 停止录音
    if (mediaRecorderRef.current) {
      mediaRecorderRef.current.stop();
    }
    
    // 关闭WebSocket（发送最后一帧）
    if (wsRef.current) {
      wsRef.current.send(JSON.stringify({
        data: {
          status: 2, // 最后一帧
        }
      }));
      wsRef.current.close();
    }
    
    setIsRecording(false);
  };
  
  return {
    isRecording,
    transcript,
    startRecording,
    stopRecording,
  };
};

// 生成科大讯飞WebSocket URL（需要签名）
const getXunfeiWebSocketURL = () => {
  const { APPID, API_KEY, API_SECRET } = getXunfeiConfig();
  const host = 'iat-api.xfyun.cn';
  const path = '/v2/iat';
  
  // 生成RFC1123格式的时间戳
  const date = new Date().toUTCString();
  
  // 生成签名
  const signatureOrigin = `host: ${host}\ndate: ${date}\nGET ${path} HTTP/1.1`;
  const signature = CryptoJS.HmacSHA256(signatureOrigin, API_SECRET);
  const signatureBase64 = CryptoJS.enc.Base64.stringify(signature);
  
  const authorizationOrigin = `api_key="${API_KEY}", algorithm="hmac-sha256", headers="host date request-line", signature="${signatureBase64}"`;
  const authorization = btoa(authorizationOrigin);
  
  return `wss://${host}${path}?authorization=${authorization}&date=${encodeURIComponent(date)}&host=${host}`;
};
```

### 4. 费用预算模块

```typescript
// backend/src/services/llm/budget.ts
export const estimateBudget = async (itinerary: Itinerary) => {
  const prompt = `
    请为以下旅行计划估算详细预算：
    
    目的地：${itinerary.destination}
    天数：${itinerary.days.length}天
    人数：${itinerary.travelers}人
    
    行程内容：
    ${itinerary.days.map((day, i) => `
      第${i + 1}天：
      ${day.events.map(e => `- ${e.name}（${e.type}）`).join('\n')}
    `).join('\n')}
    
    请估算以下费用（单位：元）：
    1. 交通费（往返机票/火车票 + 市内交通）
    2. 住宿费（按天计算）
    3. 餐饮费（按天计算，早中晚）
    4. 门票费（各景点门票）
    5. 其他费用（购物、娱乐等）
    
    以JSON格式返回：
    {
      "transportation": { "detail": "...", "amount": 3000 },
      "accommodation": { "detail": "...", "amount": 2000 },
      "meals": { "detail": "...", "amount": 1500 },
      "tickets": { "detail": "...", "amount": 800 },
      "others": { "detail": "...", "amount": 500 },
      "total": 7800,
      "budgetStatus": "适中" // 宽裕/适中/紧张
    }
  `;
  
  const response = await callDeepSeek(prompt);
  return JSON.parse(response);
};
```

### 5. 用户认证模块

```typescript
// Supabase认证集成
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 注册
export const register = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
  });
  
  if (error) throw error;
  return data;
};

// 登录
export const login = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });
  
  if (error) throw error;
  return data;
};

// 获取当前用户
export const getCurrentUser = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  return user;
};

// 登出
export const logout = async () => {
  const { error } = await supabase.auth.signOut();
  if (error) throw error;
};

// 重置密码
export const resetPassword = async (email: string) => {
  const { error } = await supabase.auth.resetPasswordForEmail(email);
  if (error) throw error;
};
```

---

## 数据库设计

### Supabase表结构

#### 1. users表（由Supabase Auth自动管理）
```sql
-- Supabase内置的auth.users表
-- 包含：id, email, encrypted_password, created_at, updated_at等
```

#### 2. user_profiles表
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  display_name VARCHAR(100),
  avatar_url TEXT,
  preferences JSONB DEFAULT '{}', -- 用户偏好设置
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Row Level Security
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = id);
```

#### 3. itineraries表
```sql
CREATE TABLE itineraries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  title VARCHAR(200) NOT NULL,
  destination VARCHAR(100) NOT NULL,
  start_date DATE,
  end_date DATE,
  days INTEGER,
  travelers INTEGER DEFAULT 1,
  budget DECIMAL(10, 2),
  preferences JSONB DEFAULT '[]',
  status VARCHAR(20) DEFAULT 'draft', -- draft, confirmed, completed
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_itineraries_user_id ON itineraries(user_id);
CREATE INDEX idx_itineraries_created_at ON itineraries(created_at DESC);

-- RLS
ALTER TABLE itineraries ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own itineraries"
  ON itineraries FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create own itineraries"
  ON itineraries FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own itineraries"
  ON itineraries FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own itineraries"
  ON itineraries FOR DELETE
  USING (auth.uid() = user_id);
```

#### 4. itinerary_days表
```sql
CREATE TABLE itinerary_days (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  itinerary_id UUID REFERENCES itineraries(id) ON DELETE CASCADE,
  day_number INTEGER NOT NULL,
  date DATE,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_itinerary_days_itinerary_id ON itinerary_days(itinerary_id);
```

#### 5. events表
```sql
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  day_id UUID REFERENCES itinerary_days(id) ON DELETE CASCADE,
  parent_event_id UUID REFERENCES events(id) ON DELETE CASCADE, -- 主事件ID（附属事件用）
  event_order INTEGER NOT NULL, -- 事件顺序
  type VARCHAR(50) NOT NULL, -- attraction, restaurant, hotel, transportation, etc.
  name VARCHAR(200) NOT NULL,
  description TEXT,
  start_time TIME,
  end_time TIME,
  estimated_duration INTEGER, -- 预计时长（分钟）
  estimated_cost DECIMAL(10, 2),
  
  -- 地理位置信息
  location_name VARCHAR(200),
  address TEXT,
  latitude DECIMAL(10, 7),
  longitude DECIMAL(10, 7),
  poi_id VARCHAR(100), -- 高德POI ID
  
  -- 附加信息
  images JSONB DEFAULT '[]',
  tips TEXT,
  is_main_event BOOLEAN DEFAULT true, -- 是否为主要事件
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_events_day_id ON events(day_id);
CREATE INDEX idx_events_parent_event_id ON events(parent_event_id);
CREATE INDEX idx_events_order ON events(event_order);
```

#### 6. budgets表
```sql
CREATE TABLE budgets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  itinerary_id UUID REFERENCES itineraries(id) ON DELETE CASCADE,
  
  -- 预算分类
  transportation_budget DECIMAL(10, 2) DEFAULT 0,
  accommodation_budget DECIMAL(10, 2) DEFAULT 0,
  meals_budget DECIMAL(10, 2) DEFAULT 0,
  tickets_budget DECIMAL(10, 2) DEFAULT 0,
  others_budget DECIMAL(10, 2) DEFAULT 0,
  total_budget DECIMAL(10, 2) DEFAULT 0,
  
  -- 实际支出（可选功能）
  transportation_spent DECIMAL(10, 2) DEFAULT 0,
  accommodation_spent DECIMAL(10, 2) DEFAULT 0,
  meals_spent DECIMAL(10, 2) DEFAULT 0,
  tickets_spent DECIMAL(10, 2) DEFAULT 0,
  others_spent DECIMAL(10, 2) DEFAULT 0,
  total_spent DECIMAL(10, 2) DEFAULT 0,
  
  notes JSONB DEFAULT '{}', -- 详细说明
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_budgets_itinerary_id ON budgets(itinerary_id);
```

#### 7. custom_markers表（用户自定义标记）
```sql
CREATE TABLE custom_markers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  itinerary_id UUID REFERENCES itineraries(id) ON DELETE CASCADE,
  name VARCHAR(200),
  latitude DECIMAL(10, 7) NOT NULL,
  longitude DECIMAL(10, 7) NOT NULL,
  icon VARCHAR(50) DEFAULT 'default',
  color VARCHAR(20) DEFAULT '#3b82f6',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_custom_markers_itinerary_id ON custom_markers(itinerary_id);
```

### 数据关系图
```
users (Supabase Auth)
  ├── user_profiles (1:1)
  └── itineraries (1:N)
        ├── itinerary_days (1:N)
        │     └── events (1:N)
        │           └── events (parent_event_id) -- 主事件与附属事件
        ├── budgets (1:1)
        └── custom_markers (1:N)
```

---

## API集成方案

### 1. 科大讯飞语音识别

#### 配置
```typescript
// config/apis.ts
export const XUNFEI_CONFIG = {
  APPID: process.env.XUNFEI_APPID!,
  API_KEY: process.env.XUNFEI_API_KEY!,
  API_SECRET: process.env.XUNFEI_API_SECRET!,
  WS_URL: 'wss://iat-api.xfyun.cn/v2/iat',
};
```

#### 集成方式
- 前端直接通过WebSocket连接
- 实时语音转文字
- 支持中英文识别

### 2. 高德地图API

#### Web服务API（后端调用）

**地点搜索**
```typescript
// services/map/geocoding.ts
export const searchPlace = async (keywords: string, city: string) => {
  const response = await axios.get('https://restapi.amap.com/v3/place/text', {
    params: {
      key: AMAP_WEB_KEY,
      keywords,
      city,
      citylimit: true,
    }
  });
  
  return response.data.pois;
};
```

**POI搜索**
```typescript
export const searchNearbyPOI = async (
  location: string,
  types: string,
  radius: number = 1000
) => {
  const response = await axios.get('https://restapi.amap.com/v3/place/around', {
    params: {
      key: AMAP_WEB_KEY,
      location,
      types,
      radius,
      offset: 20,
      sortrule: 'distance',
    }
  });
  
  return response.data.pois;
};
```

**路径规划**
```typescript
export const planRoute = async (origin: string, destination: string) => {
  const response = await axios.get('https://restapi.amap.com/v3/direction/walking', {
    params: {
      key: AMAP_WEB_KEY,
      origin,
      destination,
    }
  });
  
  return response.data.route;
};
```

#### JS API（前端调用）
- 地图展示
- 标记添加
- 路线绘制
- 地点搜索
- 地图交互

### 3. DeepSeek LLM API

#### 配置
```typescript
export const DEEPSEEK_CONFIG = {
  API_KEY: process.env.DEEPSEEK_API_KEY!,
  BASE_URL: 'https://api.deepseek.com/v1',
  MODEL: 'deepseek-chat',
};
```

#### 集成方式

**普通调用**
```typescript
export const callDeepSeek = async (prompt: string) => {
  const response = await axios.post(
    `${DEEPSEEK_CONFIG.BASE_URL}/chat/completions`,
    {
      model: DEEPSEEK_CONFIG.MODEL,
      messages: [
        { role: 'system', content: '你是一个专业的旅行规划助手' },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
    },
    {
      headers: {
        'Authorization': `Bearer ${DEEPSEEK_CONFIG.API_KEY}`,
        'Content-Type': 'application/json',
      }
    }
  );
  
  return response.data.choices[0].message.content;
};
```

**流式调用**
```typescript
export const callDeepSeekStream = async (prompt: string) => {
  const response = await fetch(
    `${DEEPSEEK_CONFIG.BASE_URL}/chat/completions`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${DEEPSEEK_CONFIG.API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: DEEPSEEK_CONFIG.MODEL,
        messages: [
          { role: 'system', content: '你是一个专业的旅行规划助手' },
          { role: 'user', content: prompt }
        ],
        stream: true,
      }),
    }
  );
  
  return response.body; // ReadableStream
};

// Express路由中使用
app.post('/api/itinerary/generate', async (req, res) => {
  const stream = await callDeepSeekStream(generatePrompt(req.body));
  
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  
  const reader = stream.getReader();
  const decoder = new TextDecoder();
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value);
    res.write(`data: ${chunk}\n\n`);
  }
  
  res.end();
});
```

### 4. Supabase

#### 配置
```typescript
export const SUPABASE_CONFIG = {
  URL: process.env.SUPABASE_URL!,
  ANON_KEY: process.env.SUPABASE_ANON_KEY!,
  SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY!, // 仅后端使用
};
```

#### 功能
- 用户认证（Auth）
- 数据存储（Database）
- 实时订阅（Realtime）
- 文件存储（Storage，可选用于用户头像）

---

## 部署方案

### Docker容器化

#### 目录结构
```
project/
├── frontend/
│   ├── Dockerfile
│   └── ...
├── backend/
│   ├── Dockerfile
│   └── ...
├── docker-compose.yml
├── .env.example
└── README.md
```

#### Frontend Dockerfile
```dockerfile
# frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci

# 构建应用
COPY . .
RUN npm run build

# 生产环境
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### Frontend nginx.conf
```nginx
server {
    listen 80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://backend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### Backend Dockerfile
```dockerfile
# backend/Dockerfile
FROM node:20-alpine

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 编译TypeScript
RUN npm run build

EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["node", "dist/app.js"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
    depends_on:
      - backend
    networks:
      - app-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
    env_file:
      - .env
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  app-network:
    driver: bridge
```

#### .env.example
```bash
# Supabase
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# DeepSeek
DEEPSEEK_API_KEY=your_deepseek_key

# 高德地图
AMAP_WEB_KEY=your_amap_web_key
AMAP_JS_KEY=your_amap_js_key

# 科大讯飞
XUNFEI_APPID=your_appid
XUNFEI_API_KEY=your_api_key
XUNFEI_API_SECRET=your_api_secret

# 应用配置
NODE_ENV=production
PORT=3000
```

### 构建和运行

#### 本地开发
```bash
# 安装依赖
cd frontend && npm install
cd ../backend && npm install

# 启动开发服务器
# 终端1
cd frontend && npm run dev

# 终端2
cd backend && npm run dev
```

#### Docker部署
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 推送到阿里云镜像仓库

#### GitHub Actions配置
```yaml
# .github/workflows/docker-build.yml
name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to Aliyun Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
    
    - name: Build and push frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: |
          registry.cn-hangzhou.aliyuncs.com/your-namespace/travel-planner-frontend:latest
          registry.cn-hangzhou.aliyuncs.com/your-namespace/travel-planner-frontend:${{ github.sha }}
    
    - name: Build and push backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: |
          registry.cn-hangzhou.aliyuncs.com/your-namespace/travel-planner-backend:latest
          registry.cn-hangzhou.aliyuncs.com/your-namespace/travel-planner-backend:${{ github.sha }}
```

#### 拉取和运行镜像
```bash
# 登录阿里云镜像仓库
docker login --username=your-username registry.cn-hangzhou.aliyuncs.com

# 拉取镜像
docker pull registry.cn-hangzhou.aliyuncs.com/your-namespace/travel-planner-frontend:latest
docker pull registry.cn-hangzhou.aliyuncs.com/your-namespace/travel-planner-backend:latest

# 运行（使用docker-compose）
docker-compose -f docker-compose.prod.yml up -d
```

---

## 开发规范

### 代码规范

#### TypeScript配置
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true
  }
}
```

#### ESLint配置
```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended"
  ],
  "rules": {
    "no-console": "warn",
    "@typescript-eslint/no-explicit-any": "error",
    "react/react-in-jsx-scope": "off"
  }
}
```

#### Prettier配置
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2
}
```

### Git工作流

#### 分支策略
- `main`: 生产分支
- `develop`: 开发分支
- `feature/*`: 功能分支
- `bugfix/*`: 修复分支

#### Commit规范
```
<type>(<scope>): <subject>

<body>

<footer>
```

类型（type）：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具更新

示例：
```
feat(itinerary): add voice input for trip planning

- Integrate Xunfei WebSocket API
- Add voice recording component
- Implement real-time transcription

Closes #123
```

### API文档

使用Swagger/OpenAPI规范：

```typescript
// backend/src/swagger.ts
import swaggerJsdoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'AI Travel Planner API',
      version: '1.0.0',
      description: 'API documentation for AI Travel Planner',
    },
    servers: [
      {
        url: 'http://localhost:3000',
        description: 'Development server',
      },
    ],
  },
  apis: ['./src/routes/*.ts'],
};

const specs = swaggerJsdoc(options);

export const setupSwagger = (app: Express) => {
  app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs));
};
```

### 测试策略

#### 单元测试
```typescript
// 使用Jest + React Testing Library
import { render, screen } from '@testing-library/react';
import { MapContainer } from './MapContainer';

describe('MapContainer', () => {
  it('should render map with markers', () => {
    const markers = [
      { id: '1', lat: 39.9, lng: 116.4, title: 'Test' }
    ];
    
    render(<MapContainer markers={markers} />);
    
    // 测试逻辑
  });
});
```

#### 集成测试
```typescript
// 测试API端点
import request from 'supertest';
import app from '../app';

describe('POST /api/itinerary/generate', () => {
  it('should generate itinerary', async () => {
    const response = await request(app)
      .post('/api/itinerary/generate')
      .send({
        destination: '日本',
        days: 5,
        budget: 10000,
      })
      .expect(200);
    
    expect(response.body).toHaveProperty('days');
  });
});
```

### 性能优化

#### 前端优化
- 代码分割（React.lazy + Suspense）
- 图片懒加载
- 防抖/节流
- 虚拟滚动（长列表）
- Service Worker（PWA可选）

#### 后端优化
- 响应缓存
- 数据库查询优化
- 连接池管理
- 限流（rate limiting）

### 安全措施

#### API安全
- HTTPS
- JWT Token认证
- CORS配置
- Rate Limiting
- Input validation

#### 密钥管理
- **绝对不要**将API Key提交到代码仓库
- 使用环境变量
- `.env`加入`.gitignore`
- 提供`.env.example`模板

---

## 附录

### 开发时间估算

| 模块 | 预计时间 |
|-----|---------|
| 项目初始化 + 环境配置 | 1天 |
| 用户认证模块 | 2天 |
| 地图集成 | 3天 |
| 语音输入模块 | 2天 |
| 行程规划核心逻辑 | 5天 |
| 行程管理界面 | 4天 |
| 费用预算模块 | 2天 |
| UI/UX优化 | 3天 |
| 测试与调试 | 3天 |
| Docker部署配置 | 1天 |
| 文档编写 | 1天 |
| **总计** | **27天** |

### 风险与挑战

1. **LLM生成质量**
   - 风险：生成的地点可能不存在
   - 应对：通过高德地图API验证所有地点

2. **语音识别准确性**
   - 风险：口音、环境噪音影响识别
   - 应对：提供文字输入作为备选方案

3. **API成本控制**
   - 风险：频繁调用LLM API成本高
   - 应对：
     - 缓存常见查询
     - 优化Prompt减少token消耗
     - 设置请求频率限制

4. **地图性能**
   - 风险：大量标记可能导致卡顿
   - 应对：
     - 标记聚合
     - 按需加载
     - 优化渲染

### 后续迭代方向

1. **Phase 2**
   - 多轮对话优化行程
   - 天气集成
   - 实时费用记录

2. **Phase 3**
   - 社交功能（分享行程）
   - 行程模板市场
   - AI导游（旅行中实时建议）

3. **Phase 4**
   - 移动端App（React Native）
   - 离线地图
   - AR导航

---

## 结语

本技术文档详细描述了AI旅行规划师的技术实现方案。采用现代化的技术栈，模块化的架构设计，确保系统的可维护性、可扩展性和性能。

关键技术点：
- ✅ React + TypeScript前端开发
- ✅ Node.js + Express后端API
- ✅ Supabase数据库与认证
- ✅ DeepSeek LLM行程规划
- ✅ 高德地图集成
- ✅ 科大讯飞语音识别
- ✅ Docker容器化部署

遵循本文档的实现方案，可以构建出功能完善、体验优秀的AI旅行规划应用。

